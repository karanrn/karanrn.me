<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Writing something after a very long time, putting this out as I could not find proper documentation for this task.
Redis [1] has become a de-facto standard for caching and all the use cases of in-memory stores so we chose Redis for caching purposes. Our team offers Platform as a Service (PaaS) which offers Redis to a few of the customers, and we run our components on Kubernetes (K8s)."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Redis cluster to cluster migration"><meta property="og:description" content="Writing something after a very long time, putting this out as I could not find proper documentation for this task.
Redis [1] has become a de-facto standard for caching and all the use cases of in-memory stores so we chose Redis for caching purposes. Our team offers Platform as a Service (PaaS) which offers Redis to a few of the customers, and we run our components on Kubernetes (K8s)."><meta property="og:type" content="article"><meta property="og:url" content="https://karanrn.me/posts/2023/08/16/redis-cluster-migration/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-16T00:00:00+00:00"><title>Redis cluster to cluster migration | Karan Nadagoudar</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.d5d17132a7c57b8affd2593d55f456bcd07c99dcee2a73a690bb158800c9a97f.css integrity="sha256-1dFxMqfFe4r/0lk9VfRWvNB8mdzuKnOmkLsViADJqX8=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.c909db7a5edebfd782c212122b897ebe4f27b9c8799b6d4282d5c73ef735d0b0.js integrity="sha256-yQnbel7ev9eCwhISK4l+vk8nuch5m21CgtXHPvc10LA=" crossorigin=anonymous></script>
<link rel=stylesheet href=/custom.css><meta name=google-site-verification content="2FJdeUvnzXlV4o7ANI6rbqjvdRflRyEuNLyvUTKq9gE"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-QSDLPEQXJ5"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QSDLPEQXJ5')</script><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Karan Nadagoudar</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://letterboxd.com/karan4080/ target=_blank rel=noopener>movies</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Redis cluster to cluster migration</strong>
<label for=toc-control></label></div></header><article class=markdown><h1><a href=/posts/2023/08/16/redis-cluster-migration/>Redis cluster to cluster migration</a></h1><h5>August 16, 2023</h5><div><a href=/categories/tech/>tech</a></div><blockquote><p>Writing something after a very long time, putting this out as I could not find proper documentation for this task.</p></blockquote><p>Redis <sup><a href=https://redis.io/>[1]</a></sup> has become a de-facto standard for caching and all the use cases of in-memory stores so we chose Redis for caching purposes. Our team offers Platform as a Service (PaaS) which offers Redis to a few of the customers, and we run our components on Kubernetes (K8s).</p><p>We chose the K8s operator<sup><a href=https://www.redhat.com/en/topics/containers/what-is-a-kubernetes-operator>[2]</a></sup> way to deploy and manage Redis clusters but we faced issues with the chosen operator so had to move away from it to deploy a stable Redis cluster that can reconcile with changes on K8s cluster like K8s upgrades and restarts.</p><p>Since we had existing customers using the Redis cluster deployed by the operator so it required us to migrate data to the new Redis cluster to make things seamless for end users. We explored a few OSS tools along with Redis&rsquo;s Migrate<sup><a href=https://redis.io/commands/migrate/>[3]</a></sup> command but one that worked for us was RedisShake<sup><a href=https://github.com/tair-opensource/RedisShake>[4]</a></sup>. RedisShake syncs data between the cluster which <strong>includes new writes</strong> on the source cluster which allows us to do a seamless cutover between Redis cluster for applications.</p><p>In a cluster setup, data is spread across the masters based on the hash range, every master is isolated with the data it holds so we need to migrate data from every master. By default, RedisShake moves data from one master node only so we need to run RedisShake for every master in the cluster.</p><p>Below are the steps to migrate data between Redis clusters using RedisShake -</p><ol start=0><li>Prerequisite - <code>python3</code>, <code>pip3</code></li><li>Download RedisShake</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir redis-shake
</span></span><span style=display:flex><span>cd redis-shake/
</span></span><span style=display:flex><span>wget https://github.com/tair-opensource/RedisShake/releases/download/v3.1.11/redis-shake-linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar -xvzf redis-shake-linux-amd64.tar.gz
</span></span></code></pre></div><ol start=2><li><p>Get details of the source and target clusters - version, redis master node, username (if using ACL), password, and check if they are <code>tls</code> enabled</p></li><li><p>Create <code>sync.toml</code> with the above details extracted, sample <a href=https://github.com/tair-opensource/RedisShake/blob/v3/sync.toml>reference</a></p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>type</span> = <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>source</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#ae81ff>7.0</span> <span style=color:#75715e># redis version, such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, ...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>address</span> = <span style=color:#e6db74>&#34;&lt;redis-master-node&gt;:&lt;redis-port&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>username</span> = <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e># keep empty if not using ACL</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>password</span> = <span style=color:#e6db74>&#34;&lt;password&gt;&#34;</span> <span style=color:#75715e># keep empty if no authentication is required</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tls</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>elasticache_psync</span> = <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e># using when source is ElastiCache. ref: https://github.com/alibaba/RedisShake/issues/373</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>target</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span> = <span style=color:#e6db74>&#34;cluster&#34;</span> <span style=color:#75715e># &#34;standalone&#34; or &#34;cluster&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#ae81ff>7.0</span> <span style=color:#75715e># redis version, such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># When the target is a cluster, write the address of one of the nodes.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># redis-shake will obtain other nodes through the `cluster nodes` command.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>address</span> = <span style=color:#e6db74>&#34;&lt;redis-master-node&gt;:&lt;redis-port&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>username</span> = <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e># keep empty if not using ACL</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>password</span> = <span style=color:#e6db74>&#34;&lt;password&gt;&#34;</span>  <span style=color:#75715e># keep empty if no authentication is required</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tls</span> = <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><ol start=4><li>RedisShake provides a Python script to run RedisShake for all the masters with just one <code>sync.toml</code> like the above. This will be available in the <code>redis-shake</code> directory from the download done in Step 1<ol><li>Install the requirements</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd cluster_helper/
</span></span><span style=display:flex><span>pip3 install -r requirements.txt
</span></span></code></pre></div><ol start=2><li>Run the <code>cluster_helper.py</code> script</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Format: python3 cluster_helper.py &lt;path to RedisShake binary&gt; &lt;path to sync.toml&gt;</span>
</span></span><span style=display:flex><span>python3 cluster_helper.py ../redis-shake sync.toml
</span></span></code></pre></div><ol start=3><li>Run the above command in the background so all the new data is synced until cutover to the new Redis cluster</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nohup python3 cluster_helper.py ../redis-shake sync.toml &amp;
</span></span></code></pre></div></li><li>Login into the target Redis cluster and validate if the keys are synced</li></ol><p>This post is only for usage of the sync feature from the RedisShake tool, it offers restore and scan features too. Following the above steps helped us to migrate data between Redis clusters running on K8s.</p><hr><h3 id=references>References:
<a class=anchor href=#references>#</a></h3><p>[1] <a href=https://redis.io/>https://redis.io/</a></p><p>[2] <a href=https://www.redhat.com/en/topics/containers/what-is-a-kubernetes-operator>https://www.redhat.com/en/topics/containers/what-is-a-kubernetes-operator</a></p><p>[3] <a href=https://redis.io/commands/migrate/>https://redis.io/commands/migrate/</a></p><p>[4] <a href=https://github.com/tair-opensource/RedisShake>https://github.com/tair-opensource/RedisShake</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>Copyright &copy; 2025 <a href=/>Karan Nadagoudar</a></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>