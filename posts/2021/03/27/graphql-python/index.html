<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="GraphQL is query language for API. It simplifies, isolates, and fastens the development and API releases. This post assumes the reader is aware of basics of GraphQL concepts like query, mutation, and schema. If you have stumbled here for introduction to GraphQL, please go through this tutorial.
Most of the implementations on the web for GraphQL with python are using Django which packs lot of features and plugins to ease the development with tradeoff to huge code base for simple application."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="GraphQL: Query filtering with relay and graphene-python"><meta property="og:description" content="GraphQL is query language for API. It simplifies, isolates, and fastens the development and API releases. This post assumes the reader is aware of basics of GraphQL concepts like query, mutation, and schema. If you have stumbled here for introduction to GraphQL, please go through this tutorial.
Most of the implementations on the web for GraphQL with python are using Django which packs lot of features and plugins to ease the development with tradeoff to huge code base for simple application."><meta property="og:type" content="article"><meta property="og:url" content="https://karanrn.me/posts/2021/03/27/graphql-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-27T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-27T00:00:00+00:00"><title>GraphQL: Query filtering with relay and graphene-python | Karan Nadagoudar</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c094b4ea1f32d91ec79c02fdbb7655286bb5d9dcf3f664101cece848e632fe15.css integrity="sha256-wJS06h8y2R7HnAL9u3ZVKGu12dzz9mQQHOzoSOYy/hU=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.72632b8d1374c78eec3ff7250433a9a97cfa1d91d9d5bced3b955534a903d53e.js integrity="sha256-cmMrjRN0x47sP/clBDOpqXz6HZHZ1bztO5VVNKkD1T4=" crossorigin=anonymous></script>
<link rel=stylesheet href=/custom.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Karan Nadagoudar</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://letterboxd.com/karan4080/ target=_blank rel=noopener>movies</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>GraphQL: Query filtering with relay and graphene-python</strong>
<label for=toc-control></label></div></header><article class=markdown><h1><a href=/posts/2021/03/27/graphql-python/>GraphQL: Query filtering with relay and graphene-python</a></h1><h5>March 27, 2021</h5><div><a href=/categories/tech/>tech</a>,
<a href=/categories/development/>development</a></div><p>GraphQL is query language for API. It simplifies, isolates, and fastens the development and API releases. This post assumes the reader is aware of basics of GraphQL concepts like query, mutation, and schema. If you have stumbled here for introduction to GraphQL, please go through this <a href=https://graphql.org/learn/>tutorial</a>.</p><p>Most of the implementations on the web for GraphQL with python are using <a href=https://www.djangoproject.com/>Django</a> which packs lot of features and plugins to ease the development with tradeoff to huge code base for simple application. I will be focusing on <a href=https://flask.palletsprojects.com/en/1.1.x/>Flask</a> as it has lesser footprint and best suited for implementing small applications.</p><p><a href=https://relay.dev/docs/>Relay</a> is a GraphQL client developed by Facebook for React. It provides pagination, caching (reusing cached data) out of the box. <a href=https://graphene-python.org/>Graphene-Python</a> has complete support for relay.</p><p>A simple query with filter (without relay) to fetch books basis title:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-graphql data-lang=graphql><span style=display:flex><span><span style=color:#66d9ef>query</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allBooks</span>(title:<span style=color:#e6db74>&#34;Da Vinci Code&#34;</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    title
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Response from the above query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;allBooks&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;3&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Da Vinci Code&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Relay uses connections, edges, and node notation to structure/format data and requests. Connections is a collection of objects containing information about edges, nodes, page, cursor, and other metadata of the page. Edges are collections of records, it helps in pagination and node is the actual record/data. More about Relay connections, edges, and node can be read <a href=https://relay.dev/graphql/connections.htm>here</a>.</p><p>I could not find easier implementation of relay with filtering using flask and graphene-python. For application to use relay, we need to add relay node to the schema for querying or mutation.</p><p>Relay can be enabled or implemented as below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BookObject</span>(SQLAlchemyObjectType):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        model <span style=color:#f92672>=</span> Book
</span></span><span style=display:flex><span>        interfaces <span style=color:#f92672>=</span> (graphene<span style=color:#f92672>.</span>relay<span style=color:#f92672>.</span>Node, )
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Query</span>(graphene<span style=color:#f92672>.</span>ObjectType):
</span></span><span style=display:flex><span>    node <span style=color:#f92672>=</span> graphene<span style=color:#f92672>.</span>relay<span style=color:#f92672>.</span>Node<span style=color:#f92672>.</span>Field()
</span></span><span style=display:flex><span>    all_books <span style=color:#f92672>=</span> SQLAlchemyConnectionField(BookObject<span style=color:#f92672>.</span>connection)
</span></span></code></pre></div><p>A sample query making use of relay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-graphql data-lang=graphql><span style=display:flex><span><span style=color:#66d9ef>query</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allBooks</span>{
</span></span><span style=display:flex><span>    edges{
</span></span><span style=display:flex><span>      node{
</span></span><span style=display:flex><span>        id
</span></span><span style=display:flex><span>        title
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A response for the above query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;allBooks&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;edges&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;node&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;Qm9va09iamVjdDoz&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Da Vinci Code&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;node&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;Qm9va09iamVjdDo1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;TensorFlow&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;node&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;Qm9va09iamVjdDo2&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Deception point&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So to enable or implement filtering the query with relay can be by sub-classing SQLAlchemyConnectionField class of graphene_sqlalchemy in graphene-python. We need to implement get_query method of the SQLAlchemyConnectionField to filter on the attributes/columns of the model.</p><p>Code for the same:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyConnectionField</span>(SQLAlchemyConnectionField):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Below attributes/fields are for pagination and implemented by relay </span>
</span></span><span style=display:flex><span>    RELAY_ARGS <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;first&#39;</span>, <span style=color:#e6db74>&#39;last&#39;</span>, <span style=color:#e6db74>&#39;before&#39;</span>, <span style=color:#e6db74>&#39;after&#39;</span>]
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_query</span>(cls, model, info, <span style=color:#f92672>**</span>args):
</span></span><span style=display:flex><span>        query <span style=color:#f92672>=</span> super(MyConnectionField, cls)<span style=color:#f92672>.</span>get_query(model, info, <span style=color:#f92672>**</span>args)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> field, value <span style=color:#f92672>in</span> args<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> field <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> cls<span style=color:#f92672>.</span>RELAY_ARGS:
</span></span><span style=display:flex><span>                query <span style=color:#f92672>=</span> query<span style=color:#f92672>.</span>filter(getattr(model, field) <span style=color:#f92672>==</span> value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> query
</span></span></code></pre></div><p>And now we can pass fields to be used for query filtering as part of our SQLAlchemyConnectionField:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Query</span>(graphene<span style=color:#f92672>.</span>ObjectType):
</span></span><span style=display:flex><span>    node <span style=color:#f92672>=</span> graphene<span style=color:#f92672>.</span>relay<span style=color:#f92672>.</span>Node<span style=color:#f92672>.</span>Field()
</span></span><span style=display:flex><span>    all_books <span style=color:#f92672>=</span> MyConnectionField(BookObject,
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> graphene<span style=color:#f92672>.</span>String(),
</span></span><span style=display:flex><span>    year <span style=color:#f92672>=</span> graphene<span style=color:#f92672>.</span>Int())
</span></span></code></pre></div><p>Now, we can query with filters using relay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-graphql data-lang=graphql><span style=display:flex><span><span style=color:#66d9ef>query</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allBooks</span>(title:<span style=color:#e6db74>&#34;Da Vinci Code&#34;</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>edges</span>{
</span></span><span style=display:flex><span>      node{
</span></span><span style=display:flex><span>        id
</span></span><span style=display:flex><span>        title
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And response for the above query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;allBooks&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;edges&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;node&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;Qm9va09iamVjdDoy&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Da Vinci Code&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For complete implementation of GraphQL in python using Flask, Graphene-Python, and SQLAlchemy, you can check the code on my <a href=https://github.com/karanrn/graphql-python>GitHub</a>.</p><hr><h3 id=references>References
<a class=anchor href=#references>#</a></h3><ol><li><p><a href=https://www.howtographql.com/basics/0-introduction/>Introduction to GraphQL</a></p></li><li><p><a href=https://docs.github.com/en/graphql/guides/introduction-to-graphql#discovering-the-graphql-api>Github GraphQL API</a></p></li><li><p><a href=https://www.prisma.io/blog/graphql-sdl-schema-definition-language-6755bcb9ce51>GraphQL Schema Definition Language</a></p></li><li><p><a href=https://jeffersonheard.github.io/python/graphql/2018/12/08/graphene-python.html>GraphQL-Flask</a></p></li><li><p><a href=https://towardsdatascience.com/use-flask-and-sqlalchemy-not-flask-sqlalchemy-5a64fafe22a4>SQLAlchemy instead of Flask-SQLAlchemy</a></p></li><li><p><a href=https://docs.graphene-python.org/en/latest/>Graphene-Python</a></p></li><li><p><a href=https://betterprogramming.pub/graphql-tutorial-how-to-use-fields-fragments-and-more-ec478896ede7>How to use Fields, Fragments, and more</a></p></li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>Copyright &copy; 2023 <a href=/>Karan Nadagoudar</a></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>